{% extends "base.html" %}

{% block title %}Conversation{% endblock %}

{% block content %}
<div class="container">
    <div class="conversation">
        <div class="conversation-window" id="conversation-window">
            {% for message in messages %}
            <div class="message {{ 'agent-message' if message.agent_id else 'user-message' }}">
                <div class="message-text">
                    {% if message.agent_id %}
                    <div class="agent-name">{{ agents_dict[message.agent_id].name }}</div>
                    {% endif %}
                    {{ message.text|safe }}
                    <span class="timestamp">{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="agent-selection">
            <label for="agent">Send message to:</label>
            <select id="agent" name="agent">
                <option value="">Select an agent</option>
                {% for agent in agents %}
                <option value="{{ agent.id }}">{{ agent.name }} ({{ agent.model }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="message-input">
            <textarea id="message" placeholder="Type your message here" rows="3" onkeydown="handleKeyDown(event)"></textarea>
            <button type="button" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <div class="project-details">
        <h2>Project Details</h2>
        <div class="ingest-section">
            <button type="button" onclick="ingestProject()">Ingest</button>
            <div class="status-indicator {{ 'green' if status_class == 'success' else 'red' }}"></div>
        </div>
        <div class="section">
            <p><strong>Project Name:</strong> {{ project.name }}</p>
        </div>
        <div class="section">
            <p><strong>Description:</strong> {{ project.description }}</p>
        </div>
        <div class="section">
            <p><strong>Git URL:</strong> <a href="{{ project.git_url }}" target="_blank">{{ project.git_url }}</a></p>
        </div>
        <div class="section">
            <p><strong>Goals:</strong> {{ project.goals or "Example waffle placeholder" }}</p>
        </div>
        <div class="section">
            <p><strong>Objectives:</strong> {{ project.objectives or "Example waffle placeholder" }}</p>
        </div>
        <div class="section">
            <p><strong>Features:</strong> {{ project.features or "Example waffle placeholder" }}</p>
        </div>
        <div class="section">
            <p><strong>Steps:</strong> {{ project.steps or "Example waffle placeholder" }}</p>
        </div>
        <a href="{{ url_for('project.edit_project', project_id=project.id) }}" class="btn btn-primary">Edit</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const lastSelectedAgent = localStorage.getItem('lastSelectedAgent');
        if (lastSelectedAgent) {
            document.getElementById('agent').value = lastSelectedAgent;
        }

        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);

            // Add copy button
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.textContent = 'Copy';
            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(block.innerText).then(() => {
                    alert('Code copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy code: ', err);
                });
            });
            block.parentElement.appendChild(copyButton);
        });

        const conversationWindow = document.getElementById('conversation-window');
        conversationWindow.scrollTop = conversationWindow.scrollHeight;
    });

    document.getElementById('agent').addEventListener('change', (event) => {
        const selectedAgent = event.target.value;
        localStorage.setItem('lastSelectedAgent', selectedAgent);
    });

    function formatAIResponse(response) {
        // Detect and format code blocks with language indication
        const codeBlockPattern = /```(\w+)\n([\s\S]+?)```/g;
        response = response.replace(codeBlockPattern, (match, lang, code) => {
            return `<pre><code class="language-${lang}">${code}</code></pre>`;
        });
        return response;
    }

    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // Prevent the default behavior of creating a new line
            sendMessage(); // Call the sendMessage function
        }
    }

    function sendMessage() {
        const messageElement = document.getElementById('message');
        const message = messageElement.value;
        const agentId = document.getElementById('agent').value;

        if (message.trim() !== '' && agentId) {
            const payload = {
                project_id: {{ project.id }},
                agent_id: agentId,
                message: message
            };

            fetch('{{ url_for('chat.send_message') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                    } else {
                        const conversationWindow = document.getElementById('conversation-window');

                        // Append user message
                        const userMessage = document.createElement('div');
                        userMessage.classList.add('message', 'user-message');
                        userMessage.innerHTML = `
                            <div class="message-text">${message.replace(/\n/g, '<br>')} <span class="timestamp">${new Date().toLocaleString()}</span></div>
                        `;
                        conversationWindow.appendChild(userMessage);

                        // Append agent response
                        const agentMessage = document.createElement('div');
                        agentMessage.classList.add('message', 'agent-message');
                        agentMessage.innerHTML = `
                            <div class="message-text"><div class="agent-name">${data.agent_name}</div>${formatAIResponse(data.reply)}</div>
                        `;
                        conversationWindow.appendChild(agentMessage);

                        conversationWindow.scrollTop = conversationWindow.scrollHeight;
                        messageElement.value = '';

                        // Re-run highlight.js on new code blocks
                        document.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightBlock(block);

                            // Add copy button
                            const copyButton = document.createElement('button');
                            copyButton.className = 'copy-button';
                            copyButton.textContent = 'Copy';
                            copyButton.addEventListener('click', () => {
                                navigator.clipboard.writeText(block.innerText).then(() => {
                                    alert('Code copied to clipboard!');
                                }).catch(err => {
                                    console.error('Failed to copy code: ', err);
                                });
                            });
                            block.parentElement.appendChild(copyButton);
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
        } else {
            alert('Please select an agent and type a message.');
        }
    }

    function ingestProject() {
        const projectId = {{ project.id }};
        const payload = { project_id: projectId };

        fetch('{{ url_for('project.clone_and_ingest', project_id=project.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                } else {
                    alert('Ingestion successful!');
                    // Update status indicator color if needed
                    document.querySelector('.status-indicator').classList.remove('red');
                    document.querySelector('.status-indicator').classList.add('green');
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
